<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MetricsWeighted • MetricsWeighted</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="MetricsWeighted">
<meta property="og:description" content="MetricsWeighted">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">MetricsWeighted</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.5.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/MetricsWeighted.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mayer79/MetricsWeighted/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>MetricsWeighted</h1>
                        <h4 class="author">Michael Mayer</h4>
            
            <h4 class="date">2020-04-18</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/mayer79/MetricsWeighted/blob/master/../../vignettes/MetricsWeighted.Rmd"><code>../../vignettes/MetricsWeighted.Rmd</code></a></small>
      <div class="hidden name"><code>MetricsWeighted.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">MetricsWeighted</span>)</pre></body></html></div>
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>The R package <code>MetricsWeighted</code> provides weighted versions of different machine learning metrics, scoring functions and performance measures as well as tools to use it within a <code>dplyr</code> chain.</p>
</div>
<div id="installation" class="section level2">
<h2 class="hasAnchor">
<a href="#installation" class="anchor"></a>Installation</h2>
<p>From CRAN:</p>
<pre><code><a href="https://rdrr.io/r/utils/install.packages.html">install.packages("MetricsWeighted")</a></code></pre>
<p>Latest version from github:</p>
<pre><code>library(devtools)
install_github("mayer79/MetricsWeighted")</code></pre>
</div>
<div id="illustration" class="section level2">
<h2 class="hasAnchor">
<a href="#illustration" class="anchor"></a>Illustration</h2>
<div id="metrics-scoring-functions-and-performance-measures" class="section level3">
<h3 class="hasAnchor">
<a href="#metrics-scoring-functions-and-performance-measures" class="anchor"></a>Metrics, Scoring Functions and Performance Measures</h3>
<p>Currently, the following metrics, scoring functions and performance measures are available:</p>
<ul>
<li><p><code>accuracy</code>, <code>recall</code>, <code>precision</code>, <code>f1_score</code>, and <code>classification_error</code>: Typical binary performance measures derived from the confusion matrix, see e.g. (<a href="https://en.wikipedia.org/wiki/Precision_and_recall" class="uri">https://en.wikipedia.org/wiki/Precision_and_recall</a>). Require binary predictions. Except for classification error, high values are better.</p></li>
<li><p><code>AUC</code> and <code>gini_coefficient</code>: Area under the receiver operating curve (ROC) and the closely related Gini coefficient. Actual values must be 0 or 1, while predictions can take any value (only their order is relevant). The higher, the better.</p></li>
<li><p><code>deviance_bernoulli</code> and <code>logLoss</code>: Further metrics relevant for binary targets, namely the average unit deviance of the <em>binary</em> logistic regression model (0-1 response) and logLoss (half that deviance). As with all deviance measures, smaller values are better.</p></li>
<li><p><code>mse</code>, <code>mae</code>, <code>mape</code>, <code>rmse</code>, and <code>medae</code>: Typical regression metrics (mean-squared error, mean absolute error, mean absolute percentage error, root-mean-squared error, and median absolute error). The lower, the better.</p></li>
<li><p><code>deviance_tweedie</code>: (Unscaled) average unit Tweedie deviance with parameter <code>tweedie_p</code>, see <span class="citation">(Jorgensen <a href="#ref-jorgensen" role="doc-biblioref">1997</a>)</span> and (<a href="https://en.wikipedia.org/wiki/Tweedie_distribution" class="uri">https://en.wikipedia.org/wiki/Tweedie_distribution</a>) for a reference of the underlying formula.</p></li>
<li><p><code>deviance_normal</code>, <code>deviance_gamma</code>, and <code>deviance_poisson</code>: Special cases of Tweedie. <code>deviance_normal</code> equals mean-squared error.</p></li>
<li><p><code>elementary_score_quantile</code> and <code>elementary_score_expectile</code>: Consistent scoring functions for quantiles and expectiles, see <span class="citation">(Ehm et al. <a href="#ref-gneiting" role="doc-biblioref">2016</a>)</span>.</p></li>
<li><p><code>prop_within</code>: Proportion of predicted values within a given band around the true values.</p></li>
</ul>
<p>They all take at least four arguments:</p>
<ol style="list-style-type: decimal">
<li><p><code>actual</code>: Actual observed values.</p></li>
<li><p><code>predicted</code>: Predicted values.</p></li>
<li><p><code>w</code>: Optional vector with case weights.</p></li>
<li><p><code>...</code>: Further arguments.</p></li>
</ol>
<div id="examples-regression" class="section level4">
<h4 class="hasAnchor">
<a href="#examples-regression" class="anchor"></a>Examples: Regression</h4>
<div class="sourceCode" id="cb4"><html><body><pre class="r"># The data
y_num  [1] 0.2428628
mae(y_num, pred_num, w = rep(1, length(y_num)))  # same
#&gt; [1] 0.2428628
mae(y_num, pred_num, w = weights)  # different
#&gt; [1] 0.2561237
rmse(y_num, pred_num)
#&gt; [1] 0.300627
medae(y_num, pred_num, w = weights) # median absolute error
#&gt; [1] 0.2381186

# Normal deviance equals Tweedie deviance with parameter 0
deviance_normal(y_num, pred_num)
#&gt; [1] 0.09037657
deviance_tweedie(y_num, pred_num, tweedie_p = 0)
#&gt; [1] 0.09037657
deviance_tweedie(y_num, pred_num, tweedie_p = -0.001)
#&gt; [1] 0.09053778

# Poisson deviance equals Tweedie deviance with parameter 1
deviance_poisson(y_num, pred_num)
#&gt; [1] 0.01531595
deviance_tweedie(y_num, pred_num, tweedie_p = 1)
#&gt; [1] 0.01531595
deviance_tweedie(y_num, pred_num, tweedie_p = 1.01)
#&gt; [1] 0.01504756

# Gamma deviance equals Tweedie deviance with parameter 2
deviance_gamma(y_num, pred_num)
#&gt; [1] 0.002633186
deviance_tweedie(y_num, pred_num, tweedie_p = 2)
#&gt; [1] 0.002633186
deviance_tweedie(y_num, pred_num, tweedie_p = 1.99)
#&gt; [1] 0.002679764
deviance_tweedie(y_num, pred_num, tweedie_p = 2.01)
#&gt; [1] 0.00258742</pre></body></html></div>
</div>
<div id="examples-binary-classification" class="section level4">
<h4 class="hasAnchor">
<a href="#examples-binary-classification" class="anchor"></a>Examples: Binary classification</h4>
<div class="sourceCode" id="cb5"><html><body><pre class="r"># The data
y_cat  [1] 0.9586
AUC(y_cat, pred_cat, w = weights)  # weighted
#&gt; [1] 0.9629734
logLoss(y_cat, pred_cat)  # Logloss
#&gt; [1] 0.2394547
deviance_bernoulli(y_cat, pred_cat)  # LogLoss * 2
#&gt; [1] 0.4789093</pre></body></html></div>
</div>
</div>
<div id="generalized-r-squared" class="section level3">
<h3 class="hasAnchor">
<a href="#generalized-r-squared" class="anchor"></a>Generalized R-squared</h3>
<p>Furthermore, we provide a generalization of R-squared, defined as the proportion of deviance explained, i.e. one minus the ratio of residual deviance and intercept-only deviance, see e.g. <span class="citation">(Cohen <a href="#ref-cohen" role="doc-biblioref">2003</a>)</span>. By default, it calculates the ordinary R-squared, i.e. proportion of <em>normal</em> deviance (mean-squared error) explained. However, you can specify any different deviance function, e.g. <code>deviance_tweedie</code> with paramter 1.5 or the deviance of the <em>binary</em> logistic regression (<code>deviance_bernoulli</code>).</p>
<div id="examples" class="section level4">
<h4 class="hasAnchor">
<a href="#examples" class="anchor"></a>Examples</h4>
<div class="sourceCode" id="cb6"><html><body><pre class="r">summary(fit_num)$r.squared
#&gt; [1] 0.8673123

# same
r_squared(y_num, pred_num)
#&gt; [1] 0.8673123
r_squared(y_num, pred_num, deviance_function = deviance_tweedie, tweedie_p = 0)
#&gt; [1] 0.8673123
r_squared(y_num, pred_num, deviance_function = deviance_tweedie, tweedie_p = 1.5)
#&gt; [1] 0.8675195

# weighted
r_squared(y_num, pred_num, w = weights)
#&gt; [1] 0.8300011
r_squared(y_num, pred_num, w = weights, deviance_function = deviance_gamma) 
#&gt; [1] 0.8300644
r_squared(y_num, pred_num, w = weights, deviance_function = deviance_tweedie, tweedie_p = 2)
#&gt; [1] 0.8300644
r_squared(y_num, pred_num, deviance_function = deviance_tweedie, tweedie_p = 1.5)
#&gt; [1] 0.8675195

# respect to own deviance formula
myTweedie  [1] 0.8675195</pre></body></html></div>
</div>
</div>
<div id="tidyverse" class="section level3">
<h3 class="hasAnchor">
<a href="#tidyverse" class="anchor"></a>Tidyverse</h3>
<p>In order to facilitate the use of these metrics in a <code>dplyr</code> chain, you can try out the function <code>performance</code>: Starting from a data set with actual and predicted values (and optional case weights), it calculates one or more metrics. The resulting values are returned as a <code>data.frame</code>. Stratified performance calculations can e.g. be done by using <code>do</code> from <code>dplyr</code>.</p>
<div id="examples-1" class="section level4">
<h4 class="hasAnchor">
<a href="#examples-1" class="anchor"></a>Examples</h4>
<div class="sourceCode" id="cb7"><html><body><pre class="r">require(dplyr)

# Regression with `Sepal.Length` as response
iris %&gt;% 
  mutate(pred = predict(fit_num, data = .)) %&gt;% 
  performance("Sepal.Length", "pred")
#&gt;   metric    value
#&gt; 1   rmse 0.300627

# Same
iris %&gt;% 
  mutate(pred = predict(fit_num, data = .)) %&gt;% 
  performance("Sepal.Length", "pred", metrics = rmse)
#&gt;   metric    value
#&gt; 1   rmse 0.300627

# Grouped by Species
iris %&gt;% 
  mutate(pred = predict(fit_num, data = .)) %&gt;% 
  group_by(Species) %&gt;% 
  do(performance(., actual = "Sepal.Length", predicted = "pred"))
#&gt; # A tibble: 3 x 3
#&gt; # Groups:   Species [3]
#&gt;   Species    metric value
#&gt;   <fct><fct><dbl>
#&gt; 1 setosa     rmse   0.254
#&gt; 2 versicolor rmse   0.329
#&gt; 3 virginica  rmse   0.313

# Customized output
iris %&gt;% 
  mutate(pred = predict(fit_num, data = .)) %&gt;% 
  performance("Sepal.Length", "pred", value = "performance",
              metrics = list(`root-mean-squared error` = rmse))
#&gt;                    metric performance
#&gt; 1 root-mean-squared error    0.300627

# Multiple measures
iris %&gt;% 
  mutate(pred = predict(fit_num, data = .)) %&gt;% 
  performance("Sepal.Length", "pred",
              metrics = list(rmse = rmse, mae = mae, `R-squared` = r_squared))
#&gt;      metric     value
#&gt; 1      rmse 0.3006270
#&gt; 2       mae 0.2428628
#&gt; 3 R-squared 0.8673123

# Grouped by Species
iris %&gt;% 
  mutate(pred = predict(fit_num, data = .)) %&gt;% 
  group_by(Species) %&gt;% 
  do(performance(., "Sepal.Length", "pred",
                 metrics = list(rmse = rmse, mae = mae, `R-squared` = r_squared)))
#&gt; # A tibble: 9 x 3
#&gt; # Groups:   Species [3]
#&gt;   Species    metric    value
#&gt;   <fct><fct><dbl>
#&gt; 1 setosa     rmse      0.254
#&gt; 2 setosa     mae       0.201
#&gt; 3 setosa     R-squared 0.469
#&gt; 4 versicolor rmse      0.329
#&gt; 5 versicolor mae       0.276
#&gt; 6 versicolor R-squared 0.585
#&gt; 7 virginica  rmse      0.313
#&gt; 8 virginica  mae       0.252
#&gt; 9 virginica  R-squared 0.752

# Passing extra argument (Tweedie p)
iris %&gt;% 
  mutate(pred = predict(fit_num, data = .)) %&gt;% 
  performance("Sepal.Length", "pred",
              metrics = list(`normal deviance` = deviance_normal, 
                             `Tweedie with p = 0` = deviance_tweedie),
              tweedie_p = 0)
#&gt;               metric      value
#&gt; 1    normal deviance 0.09037657
#&gt; 2 Tweedie with p = 0 0.09037657</dbl></fct></fct></dbl></fct></fct></pre></body></html></div>
</div>
</div>
<div id="parametrized-scoring-functions" class="section level3">
<h3 class="hasAnchor">
<a href="#parametrized-scoring-functions" class="anchor"></a>Parametrized scoring functions</h3>
<p>Some scoring functions depend on a further parameter <span class="math inline">\(p\)</span>, e.g.</p>
<ul>
<li>
<code>tweedie_deviance</code> and <code>r_squared</code> for <code>deviance_function = deviance_tweedie</code>: depends on <code>tweedie_p</code>,</li>
<li>
<code>elementary_score_expectile</code>, <code>elementary_score_quantile</code>: depend on <code>theta</code>.</li>
<li>
<code>prop_within</code>: Depend on <code>tol</code>.</li>
</ul>
<p>It might be of key relevance to evaluate such function for varying <span class="math inline">\(p\)</span>. That is where the function <code>multi_metric</code> shines.</p>
<div id="examples-2" class="section level4">
<h4 class="hasAnchor">
<a href="#examples-2" class="anchor"></a>Examples</h4>
<div class="sourceCode" id="cb8"><html><body><pre class="r">ir    Tweedie p    deviance
#&gt; 1       0.0 0.090376567
#&gt; 2       1.0 0.015315945
#&gt; 3       1.2 0.010757362
#&gt; 4       1.4 0.007559956
#&gt; 5       1.6 0.005316008
#&gt; 6       1.8 0.003740296

# Murphy diagram
plot(deviance ~ `Tweedie p`, data = perf, type = "s")</pre></body></html></div>
<p><img src="MetricsWeighted_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<div class="sourceCode" id="cb9"><html><body><pre class="r">
# Same for Tweedie-R-squared
multi_Tweedie_r2 </pre></body></html></div>
<p><img src="MetricsWeighted_files/figure-html/unnamed-chunk-6-2.png" width="700"></p>
</div>
</div>
</div>
<div id="references" class="section level2 unnumbered">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<div id="refs" class="references">
<div id="ref-cohen">
<p>Cohen, Cohen, J. 2003. <em>Applied Multiple Regression/Correlation Analysis for the Behavioral Sciences</em>. New York: Routledge. <a href="https://doi.org/10.4324/9780203774441">https://doi.org/10.4324/9780203774441</a>.</p>
</div>
<div id="ref-gneiting">
<p>Ehm, Werner, Tilmann Gneiting, Alexander Jordan, and Fabian Krüger. 2016. “Of Quantiles and Expectiles: Consistent Scoring Functions, Choquet Representations and Forecast Rankings.” <em>Journal of the Royal Statistical Society: Series B (Statistical Methodology)</em> 78 (3): 505–62. <a href="https://doi.org/10.1111/rssb.12154">https://doi.org/10.1111/rssb.12154</a>.</p>
</div>
<div id="ref-jorgensen">
<p>Jorgensen, B. 1997. <em>The Theory of Dispersion Models</em>. Chapman &amp; Hall/Crc Monographs on Statistics &amp; Applied Probability. Taylor &amp; Francis.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Michael Mayer.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.0.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
